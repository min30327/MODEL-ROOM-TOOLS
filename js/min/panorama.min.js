App.controller("ViewController",["$scope","$filter",function(e){function t(){w=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,1,1e3),h=new THREE.Scene,e.views=[{url:"img/view/"+e.view.path+"/pz.jpg",position:[-448,0,0],rotation:[0,Math.PI/2,0]},{url:"img/view/"+e.view.path+"/nx.jpg",position:[448,0,0],rotation:[0,-Math.PI/2,0]},{url:"img/view/"+e.view.path+"/ny.jpg",position:[0,448,0],rotation:[Math.PI/2,0,Math.PI]},{url:"img/view/"+e.view.path+"/py.jpg",position:[0,-448,0],rotation:[-Math.PI/2,0,Math.PI]},{url:"img/view/"+e.view.path+"/nz.jpg",position:[0,0,448],rotation:[0,Math.PI,0]},{url:"img/view/"+e.view.path+"/px.jpg",position:[0,0,-448],rotation:[0,0,0]}];for(var t=0;t<e.views.length;t++){var o=e.views[t],a=document.createElement("img");a.width=900,a.src=o.url,M[t]=new THREE.CSS3DObject(a),M[t].position.fromArray(o.position),M[t].rotation.fromArray(o.rotation),h.add(M[t])}m=new THREE.CSS3DRenderer,m.setSize(window.innerWidth,window.innerHeight-47),$("#ViewRenderer").html(m.domElement),F.addEventListener("mousedown",i,!1),F.addEventListener("touchstart",r,!1),F.addEventListener("touchmove",s,!1),F.addEventListener("gesturechange",v,!1),F.addEventListener("mousewheel",d,!1),window.addEventListener("resize",n,!1)}function n(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),m.setSize(window.innerWidth,window.innerHeight-47)}function i(e){e.preventDefault(),F.addEventListener("mousemove",o,!1),F.addEventListener("mouseup",a,!1)}function o(e){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0;L-=.5*t}function a(){F.removeEventListener("mousemove",o),F.removeEventListener("mouseup",a)}function r(e){e.preventDefault();var t=e.touches[0];C=t.screenX}function s(e){e.preventDefault();var t=e.touches[0];L-=.5*(t.screenX-C),C=t.screenX}function d(e){e.preventDefault();var t=w.fov-.05*e.wheelDeltaY;t=g>t?g:t>E?E:t,w.fov=t,w.updateProjectionMatrix()}function v(e){var t=w.fov-(e.scale-1);t=g>t?g:t>E?E:t,w.fov=t,w.updateProjectionMatrix()}function c(){e.auto&&(L+=.1),H=Math.max(-85,Math.min(85,H)),x=THREE.Math.degToRad(90-H),y=THREE.Math.degToRad(L),f.x=Math.sin(x)*Math.cos(y),f.y=Math.cos(x),f.z=Math.sin(x)*Math.sin(y);var t=parseFloat(R.data("deg")+(L-90));R.css("transform","rotate("+t+"deg)")}function l(){c(),requestAnimationFrame(l),w.lookAt(f),u()}function u(){m.render(h,w)}function p(){cancelAnimationFrame(l),L=90,y=0;for(var t=0;t<e.views.length;t++)h.remove(M[t])}var w,h,m,f=new THREE.Vector3,g=30,E=70,M=[];e.auto=!0;var R=$(".beam"),P=[{path:"a-15-night",title:"15F 夜景"},{path:"a-15",title:"15F"},{path:"a-13",title:"13F"},{path:"a-10",title:"10F"},{path:"a-8",title:"8F"},{path:"a-5",title:"5F"},{path:"a-2",title:"2F"}],j=["pz","nx","ny","py","nz","px"],L=90,H=0,x=0,y=0;e.view=P[0],e.view_paths=P;var C,F=document.getElementById("ViewRenderer");ons.ready(function(){Loading.run(),setTimeout(function(){e.imgPreload(),t(),l()},200),tabbar.on("prechange",function(e){$("#viewBtn").hasClass("active")&&2==e.index&&e.cancel()})}),e.switchView=function(n){$(".side").find(".side-list-item .svg-wrapper").removeClass("active"),$("#ViewRenderer").stop().fadeOut("fast",function(){$(".side").find(".side-list-item").eq(n).find(".svg-wrapper").addClass("active"),e.view=P[n],p(),t(),$("#ViewRenderer").fadeIn("fast")})},e.sideClose=function(){$(".side,.btn-close").toggleClass("close")},e.switch_auto=function(){$(".btn-animate").toggleClass("active"),e.auto=e.auto?!1:!0},e.imgPreload=function(){var e=1;for(var t in P)for(var n=0;n<j.length;n++){var i=document.createElement("img");i.src="img/view/"+P[t].path+"/"+j[n]+".jpg",console.log(e),e==Object.keys(P).length*j.length&&(i.onload=function(){console.log("complete!"),Loading.complete()}),e++}}}]);